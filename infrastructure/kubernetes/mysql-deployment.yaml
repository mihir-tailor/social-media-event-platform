apiVersion: v1
kind: Secret
metadata:
  name: mysql-secret
  namespace: social-media-platform
type: Opaque
stringData:
  username: root
  password: your-secure-password-here
  database: social_media_analytics
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: mysql-initdb
  namespace: social-media-platform
data:
  init.sql: |
    CREATE DATABASE IF NOT EXISTS social_media_analytics;
    USE social_media_analytics;
    
    CREATE TABLE IF NOT EXISTS event_metrics_5min (
        id BIGINT AUTO_INCREMENT PRIMARY KEY,
        window_start TIMESTAMP NOT NULL,
        window_end TIMESTAMP NOT NULL,
        event_type VARCHAR(20) NOT NULL,
        platform VARCHAR(20) NOT NULL,
        event_count BIGINT NOT NULL DEFAULT 0,
        unique_users BIGINT NOT NULL DEFAULT 0,
        computed_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
        INDEX idx_window_start (window_start),
        INDEX idx_event_type (event_type),
        INDEX idx_platform (platform),
        INDEX idx_composite (window_start, event_type, platform)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
    
    CREATE TABLE IF NOT EXISTS user_metrics_1hr (
        id BIGINT AUTO_INCREMENT PRIMARY KEY,
        window_start TIMESTAMP NOT NULL,
        window_end TIMESTAMP NOT NULL,
        user_id VARCHAR(100) NOT NULL,
        platform VARCHAR(20) NOT NULL,
        total_events BIGINT NOT NULL DEFAULT 0,
        likes BIGINT NOT NULL DEFAULT 0,
        comments BIGINT NOT NULL DEFAULT 0,
        shares BIGINT NOT NULL DEFAULT 0,
        views BIGINT NOT NULL DEFAULT 0,
        clicks BIGINT NOT NULL DEFAULT 0,
        computed_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
        INDEX idx_window_start (window_start),
        INDEX idx_user_id (user_id),
        INDEX idx_platform (platform)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
---
apiVersion: v1
kind: Service
metadata:
  name: mysql-service
  namespace: social-media-platform
  labels:
    app: mysql
spec:
  ports:
  - port: 3306
    targetPort: 3306
    name: mysql
  selector:
    app: mysql
  clusterIP: None
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mysql
  namespace: social-media-platform
spec:
  serviceName: mysql-service
  replicas: 1
  selector:
    matchLabels:
      app: mysql
  template:
    metadata:
      labels:
        app: mysql
    spec:
      containers:
      - name: mysql
        image: mysql:8.0
        ports:
        - containerPort: 3306
          name: mysql
        env:
        - name: MYSQL_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mysql-secret
              key: password
        - name: MYSQL_DATABASE
          valueFrom:
            secretKeyRef:
              name: mysql-secret
              key: database
        resources:
          requests:
            memory: "2Gi"
            cpu: "1000m"
          limits:
            memory: "4Gi"
            cpu: "2000m"
        volumeMounts:
        - name: mysql-data
          mountPath: /var/lib/mysql
        - name: mysql-initdb
          mountPath: /docker-entrypoint-initdb.d
        livenessProbe:
          exec:
            command:
            - mysqladmin
            - ping
            - -h
            - localhost
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          exec:
            command:
            - mysqladmin
            - ping
            - -h
            - localhost
          initialDelaySeconds: 10
          periodSeconds: 5
      volumes:
      - name: mysql-initdb
        configMap:
          name: mysql-initdb
  volumeClaimTemplates:
  - metadata:
      name: mysql-data
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 100Gi